{"version":3,"sources":["assets\\Script\\scene\\score-scene.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["const { ccclass, property } = cc._decorator;\r\n\r\n@ccclass\r\nexport default class ResultScene extends cc.Component {\r\n    @property(cc.Label)\r\n    scoreLabel: cc.Label = null;\r\n\r\n    @property(cc.Label)\r\n    sceneLabel: cc.Label = null;  // 拖 UI Label 進來\r\n\r\n    @property({ type: cc.AudioClip })\r\n    resultBgm: cc.AudioClip = null;\r\n\r\n    @property({ type: cc.Prefab })\r\n    star1Prefab: cc.Prefab = null;\r\n\r\n    @property({ type: cc.Prefab })\r\n    star2Prefab: cc.Prefab = null;\r\n\r\n    @property({ type: cc.Prefab })\r\n    star3Prefab: cc.Prefab = null;\r\n\r\n    @property({ type: cc.Node })\r\n    starParent: cc.Node = null;\r\n\r\n    @property({ type: cc.Node })\r\n    char1Node: cc.Node = null;\r\n    @property({ type: [cc.SpriteFrame] })\r\n    char1Frames: cc.SpriteFrame[] = [];   // 3張圖片\r\n\r\n    @property({ type: cc.Node })\r\n    char2Node: cc.Node = null;\r\n    @property({ type: [cc.SpriteFrame] })\r\n    char2Frames: cc.SpriteFrame[] = [];   // 3張圖片\r\n\r\n    private char1FrameIdx = 0;\r\n    private char2FrameIdx = 0;\r\n    private _sceneChanged = false;\r\n\r\n    async start() {\r\n        cc.audioEngine.stopMusic();\r\n        cc.audioEngine.playMusic(this.resultBgm, true);\r\n\r\n        // 拿分數和來源場景\r\n        const scorePersistNode = cc.director.getScene().getChildByName('ScorePersist');\r\n        if (!scorePersistNode) {\r\n            cc.error('找不到 ScorePersist persist node');\r\n            return;\r\n        }\r\n        const scorePersistScript = scorePersistNode.getComponent('ScorePersist');\r\n        const score = scorePersistScript.score || 0;\r\n        const fromScene = scorePersistScript.fromScene || '';\r\n\r\n        // 拿 userId\r\n        const userPersistNode = cc.director.getScene().getChildByName('PersistentUser');\r\n        if (!userPersistNode) {\r\n            cc.warn('找不到 PersistentUser persist node，無法同步分數');\r\n        } else {\r\n            const userScript = userPersistNode.getComponent('PersistentUser');\r\n            const userId = userScript.userId;\r\n            const username = userScript.nickname || \"\"; // <-- 這裡\r\n\r\n            if (userId) {\r\n                try {\r\n                    const db = firebase.database();\r\n                    const scoreRef = db.ref(`scores/${userId}`);\r\n                    const snapshot = await scoreRef.once(\"value\");\r\n                    const oldScore = snapshot.val() ? snapshot.val().score : 0;\r\n                    if (score > oldScore) {\r\n                        await scoreRef.set({\r\n                            score,\r\n                            scene: fromScene,\r\n                            username    // <== 寫入 username\r\n                        });\r\n                        cc.log(\"分數已刷新到 Firebase\");\r\n                    } else {\r\n                        cc.log(\"分數未刷新（未超過舊分數）\");\r\n                    }\r\n                } catch (err) {\r\n                    cc.error(\"Firebase 更新分數失敗\", err);\r\n                }\r\n            } else {\r\n                cc.warn(\"userId 尚未設定，無法同步分數\");\r\n            }\r\n        }\r\n\r\n\r\n        // 顯示分數\r\n        if (this.scoreLabel) {\r\n            this.scoreLabel.string = `${score}`;\r\n        }\r\n\r\n        // 顯示來源場景名稱\r\n        if (this.sceneLabel) {\r\n            this.sceneLabel.string = fromScene;\r\n        }\r\n\r\n        // 根據分數顯示 n 顆星\r\n        let starPrefabs = [];\r\n        if (score >= 500) {\r\n            starPrefabs = [this.star3Prefab, this.star2Prefab, this.star1Prefab];\r\n        } else if (score >= 200) {\r\n            starPrefabs = [this.star2Prefab, this.star1Prefab];\r\n        } else if (score >= 50) {\r\n            starPrefabs = [this.star1Prefab];\r\n        }\r\n\r\n        // 實例化並顯示\r\n        if (this.starParent) {\r\n            for (let prefab of starPrefabs) {\r\n                if (prefab) {\r\n                    const node = cc.instantiate(prefab);\r\n                    this.starParent.addChild(node);\r\n                }\r\n            }\r\n        }\r\n\r\n        this.schedule(this.updateCharFrames, 0.25);\r\n\r\n        // 1. 註冊空白鍵監聽\r\n        cc.systemEvent.on(cc.SystemEvent.EventType.KEY_DOWN, this.onKeyDown, this);\r\n\r\n        // 2. 十秒自動跳場景\r\n        this.scheduleOnce(() => {\r\n            this.gotoMenu();\r\n        }, 10);\r\n    }\r\n\r\n\r\n    onDestroy() {\r\n        cc.systemEvent.off(cc.SystemEvent.EventType.KEY_DOWN, this.onKeyDown, this);\r\n    }\r\n\r\n    onKeyDown(event: cc.Event.EventKeyboard) {\r\n        // 空白鍵是 cc.macro.KEY.space\r\n        if (event.keyCode === cc.macro.KEY.space) {\r\n            this.gotoMenu();\r\n        }\r\n    }\r\n\r\n    gotoMenu() {\r\n        if (this._sceneChanged) return;\r\n        this._sceneChanged = true;\r\n        cc.director.loadScene('selectScene');  // 你的主選單場景名\r\n    }\r\n\r\n    updateCharFrames() {\r\n        // 角色1\r\n        if (this.char1Node && this.char1Frames.length > 0) {\r\n            let sprite1 = this.char1Node.getComponent(cc.Sprite);\r\n            if (sprite1) {\r\n                sprite1.spriteFrame = this.char1Frames[this.char1FrameIdx];\r\n                this.char1FrameIdx = (this.char1FrameIdx + 1) % this.char1Frames.length;\r\n            }\r\n        }\r\n\r\n        // 角色2\r\n        if (this.char2Node && this.char2Frames.length > 0) {\r\n            let sprite2 = this.char2Node.getComponent(cc.Sprite);\r\n            if (sprite2) {\r\n                sprite2.spriteFrame = this.char2Frames[this.char2FrameIdx];\r\n                this.char2FrameIdx = (this.char2FrameIdx + 1) % this.char2Frames.length;\r\n            }\r\n        }\r\n    }\r\n}\r\n"]}