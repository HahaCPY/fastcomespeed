{"version":3,"sources":["assets/Script/scene/ScorePersist.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;IAA0C,gCAAY;IAAtD;QAAA,qEA+CC;QA9CU,WAAK,GAAW,CAAC,CAAC;QAClB,eAAS,GAAW,EAAE,CAAC;QACvB,YAAM,GAAW,EAAE,CAAC,CAAC,mBAAmB;;IA4CnD,CAAC;IA1CG,6BAAM,GAAN;QACI,EAAE,CAAC,IAAI,CAAC,kBAAkB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,UAAU;IACrD,CAAC;IAED;;;;OAIG;IACG,0CAAmB,GAAzB,UAA0B,QAAgB;;uCAAG,OAAO;;;;;wBAChD,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE;4BACd,EAAE,CAAC,IAAI,CAAC,oBAAoB,CAAC,CAAC;4BAC9B,sBAAO,KAAK,EAAC;yBAChB;wBAEK,EAAE,GAAG,QAAQ,CAAC,QAAQ,EAAE,CAAC;wBACzB,QAAQ,GAAG,EAAE,CAAC,GAAG,CAAC,YAAU,IAAI,CAAC,MAAQ,CAAC,CAAC;;;;wBAI5B,qBAAM,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,EAAA;;wBAAvC,QAAQ,GAAG,SAA4B;wBACvC,IAAI,GAAG,QAAQ,CAAC,GAAG,EAAE,CAAC;wBACtB,QAAQ,SAAG,IAAI,aAAJ,IAAI,uBAAJ,IAAI,CAAE,KAAK,mCAAI,CAAC,CAAC;6BAG9B,CAAA,QAAQ,GAAG,QAAQ,CAAA,EAAnB,wBAAmB;wBACnB,cAAc;wBACd,qBAAM,QAAQ,CAAC,GAAG,CAAC;gCACf,KAAK,EAAE,QAAQ;gCACf,KAAK,EAAE,IAAI,CAAC,SAAS;gCACrB,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;6BACxB,CAAC,EAAA;;wBALF,cAAc;wBACd,SAIE,CAAC;wBACH,IAAI,CAAC,KAAK,GAAG,QAAQ,CAAC,CAAC,QAAQ;wBAC/B,sBAAO,IAAI,EAAC;;oBAEhB,UAAU;oBACV,sBAAO,KAAK,EAAC;;;wBAEb,EAAE,CAAC,KAAK,CAAC,sBAAsB,EAAE,KAAG,CAAC,CAAC;wBACtC,sBAAO,KAAK,EAAC;;;;;KAEpB;IACL,mBAAC;AAAD,CA/CA,AA+CC,CA/CyC,EAAE,CAAC,SAAS,GA+CrD","file":"","sourceRoot":"/","sourcesContent":["export default class ScorePersist extends cc.Component {\n    public score: number = 0;\n    public fromScene: string = \"\";\n    public userId: string = \"\"; // å»ºè­°è¨­ä¸€å€‹å”¯ä¸€ user key\n\n    onLoad() {\n        cc.game.addPersistRootNode(this.node); // å ´æ™¯åˆ‡æ›ä¸ç§»é™¤\n    }\n\n    /**\n     * æª¢æŸ¥åˆ†æ•¸ï¼Œå¿…è¦æ™‚å¯«å…¥ Firebase Realtime Database\n     * @param newScore æ–°åˆ†æ•¸\n     * @returns å¯«å…¥ç‹€æ…‹\n     */\n    async updateScoreIfHigher(newScore: number): Promise<boolean> {\n        if (!this.userId) {\n            cc.warn(\"userId å°šæœªè¨­å®šï¼Œç„¡æ³•åŒæ­¥åˆ†æ•¸\");\n            return false;\n        }\n\n        const db = firebase.database();\n        const scoreRef = db.ref(`scores/${this.userId}`);\n\n        try {\n            // å–å¾—èˆŠåˆ†æ•¸\n            const snapshot = await scoreRef.once(\"value\");\n            const data = snapshot.val();\n            const oldScore = data?.score ?? 0;\n\n            // æ¯”è¼ƒ\n            if (newScore > oldScore) {\n                // åªè¦æ–°åˆ†æ•¸æ¯”è¼ƒé«˜æ‰å¯«å…¥\n                await scoreRef.set({\n                    score: newScore,\n                    scene: this.fromScene,\n                    updatedAt: Date.now()\n                });\n                this.score = newScore; // æœ¬åœ°ä¹Ÿæ›´æ–°\n                return true;\n            }\n            // æ²’æ›´é«˜ï¼Œä¸å¯«å…¥\n            return false;\n        } catch (err) {\n            cc.error(\"ğŸ”¥ Firebase è³‡æ–™åº«è®€å¯«å¤±æ•—ï¼š\", err);\n            return false;\n        }\n    }\n}\n"]}